<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coral - Today's Impact</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/p5@1.9.3/lib/p5.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="hamburger-menu">
                    <i class="fas fa-bars"></i>
                </div>
                <div class="logo">
                    <h1>Coral</h1>
                    <p class="subtitle">Today's Impact</p>
                </div>
                <div class="user-profile">
                    <i class="fas fa-user-circle"></i>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Impact Display -->
            <section class="impact-display">
                <div class="impact-circle">
                    <div class="progress-ring">
                        <svg class="progress-ring-svg" width="200" height="200">
                            <circle
                                class="progress-ring-circle-bg"
                                stroke="rgba(255, 255, 255, 0.2)"
                                stroke-width="8"
                                fill="transparent"
                                r="90"
                                cx="100"
                                cy="100"
                            />
                            <circle
                                class="progress-ring-circle"
                                stroke="#4ade80"
                                stroke-width="8"
                                fill="transparent"
                                r="90"
                                cx="100"
                                cy="100"
                                stroke-dasharray="565.48"
                                stroke-dashoffset="424.11"
                            />
                        </svg>
                        <div class="impact-icon" id="coral-container">
                            <!-- Coral visualization will be inserted here -->
                        </div>
                    </div>
                    <div class="impact-text">
                        <div class="impact-percentage">25%</div>
                        <div class="impact-label">Daily Goal</div>
                    </div>
                </div>
            </section>

            <!-- Statistics Cards -->
            <section class="stats-section">
                <div class="stats-grid">
                    <div class="stat-card co2-saved">
                        <div class="stat-value">2.4kg</div>
                        <div class="stat-label">CO‚ÇÇ Saved Today</div>
                    </div>
                    <div class="stat-card day-streak">
                        <div class="stat-value">7</div>
                        <div class="stat-label">Day Streak</div>
                    </div>
                </div>
            </section>

            <!-- Coral Testing Controls -->
            <section class="coral-testing" style="margin: 20px 0; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 15px;">
                <div class="section-header">
                    <h2 style="font-size: 1.2em; margin-bottom: 15px;">üß™ Coral Testing</h2>
                </div>
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <label for="coral-points-slider" style="color: white; font-size: 0.9em; min-width: 80px;">
                        Points: <span id="coral-points-display">25</span>
                    </label>
                    <input 
                        type="range" 
                        id="coral-points-slider" 
                        min="0" 
                        max="200" 
                        value="5"
                        style="flex: 1; min-width: 150px; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; outline: none; -webkit-appearance: none;"
                    />
                    <button id="coral-random-btn" style="padding: 8px 16px; background: rgba(76,222,128,0.2); color: #4ade80; border: 1px solid #4ade80; border-radius: 20px; cursor: pointer; font-size: 0.8em;">
                        üé≤ Random
                    </button>
                    <button onclick="openCameraVerification(1, 'Ride a bike instead of walking')" style="padding: 8px 16px; background: rgba(74,222,128,0.2); color: #4ade80; border: 1px solid #4ade80; border-radius: 20px; cursor: pointer; font-size: 0.8em;">
                        üö¥‚Äç‚ôÄÔ∏è Test Bike Goal
                    </button>
                </div>
            </section>

            <!-- Today's Tasks -->
            <section class="tasks-section">
                <div class="section-header">
                    <h2>Today's Tasks</h2>
                    <a href="todo.html" class="view-all">View All</a>
                </div>
                <div class="tasks-list" id="tasksList">
                    <!-- Tasks will be dynamically added here -->
                </div>
            </section>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="#" class="nav-item active">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="todo.html" class="nav-item">
                <i class="fas fa-leaf"></i>
                <span>Tasks</span>
            </a>
            <a href="progress.html" class="nav-item">
                <i class="fas fa-chart-line"></i>
                <span>Progress</span>
            </a>
            <a href="community.html" class="nav-item">
                <i class="fas fa-users"></i>
                <span>Community</span>
            </a>
        </nav>
    </div>

    <script src="script.js"></script>
    
    <!-- Coral Visualization Script -->
    <script>
        // Coral visualization variables
        let coralPoints = 5;
        let coralMaxPoints = 200;
        let coralGrowth = 0;
        let coralTargetPoints = 5;
        let coralSeed = 42;
        let breezeT = 0;
        let coralCanvas;

        // Visual scales - coral 1.3x bigger
        const baseLen = 26;  // 1.3x bigger (20 * 1.3 = 26)
        const minLen = 2.0;  // 1.3x bigger (1.5 * 1.3 = 1.95 ‚âà 2.0)
        const maxDepth = 7;
        const splitAngle = Math.PI / 4;
        const sway = 0.15;
        const baseThickness = 3.5;  // 1.3x bigger (2.7 * 1.3 = 3.51 ‚âà 3.5)

        function setCoralPoints(p) {
            coralTargetPoints = Math.max(0, Math.min(p, coralMaxPoints));
            updateCoralDisplay();
        }

        function updateCoralDisplay() {
            const growthPercent = Math.round((coralTargetPoints / coralMaxPoints) * 100);
            document.getElementById('coral-points-display').textContent = Math.round(coralTargetPoints);
            document.getElementById('coral-points-slider').value = coralTargetPoints;
            
            // Update the percentage display
            document.querySelector('.impact-percentage').textContent = growthPercent + '%';
            
            // Update progress ring
            const circumference = 565.48;
            const offset = circumference - (coralTargetPoints / coralMaxPoints) * circumference;
            document.querySelector('.progress-ring-circle').style.strokeDashoffset = offset;
        }

        function coralGrowthToColor(g) {
            // Coral bleaching to vibrant life progression
            if (g < 0.05) {
                // Dead/bleached coral - very pale white/grey
                return color(220, 215, 210); // Bleached white
            } else if (g < 0.15) {
                // Starting to recover - pale grey to light brown
                const t = (g - 0.05) / 0.1;
                return lerpColor(color(220, 215, 210), color(180, 160, 140), t);
            } else if (g < 0.3) {
                // Early recovery - brown to pale green
                const t = (g - 0.15) / 0.15;
                return lerpColor(color(180, 160, 140), color(140, 170, 130), t);
            } else if (g < 0.5) {
                // Growing healthy - green to orange
                const t = (g - 0.3) / 0.2;
                return lerpColor(color(140, 170, 130), color(255, 150, 80), t);
            } else if (g < 0.75) {
                // Thriving - orange to pink
                const t = (g - 0.5) / 0.25;
                return lerpColor(color(255, 150, 80), color(255, 120, 160), t);
            } else {
                // Magnificent - pink to vibrant coral
                const t = (g - 0.75) / 0.25;
                return lerpColor(color(255, 120, 160), color(255, 90, 140), t);
            }
        }

        function setup() {
            // Create bigger canvas - 1.3x larger (120 * 1.3 = 156)
            coralCanvas = createCanvas(156, 156);
            coralCanvas.parent('coral-container');
            coralCanvas.style('border-radius', '50%');
            coralCanvas.style('position', 'absolute');
            coralCanvas.style('top', '50%');
            coralCanvas.style('left', '50%');
            coralCanvas.style('transform', 'translate(-50%, -50%)');
            coralCanvas.style('z-index', '10');
            
            pixelDensity(window.devicePixelRatio || 1);
            noiseSeed(coralSeed);
            randomSeed(coralSeed);
            
            // Setup event listeners
            document.getElementById('coral-points-slider').addEventListener('input', (e) => {
                setCoralPoints(parseInt(e.target.value));
            });

            document.getElementById('coral-random-btn').addEventListener('click', () => {
                const randomPoints = Math.floor(Math.random() * 180) + 10;
                setCoralPoints(randomPoints);
            });
            
            setCoralPoints(5); // Start with bleached coral
        }

        function draw() {
            // Clear with transparent background
            clear();
            
            coralPoints = lerp(coralPoints, coralTargetPoints, 0.06);
            const raw = constrain(coralPoints / coralMaxPoints, 0, 1);
            coralGrowth = easeOutCubic(raw);
            breezeT += 0.008;

            // Draw underwater background (circular)
            push();
            noStroke();
            // Create circular mask effect - 1.3x bigger
            let gradient = drawingContext.createRadialGradient(78, 78, 0, 78, 78, 78);
            gradient.addColorStop(0, 'rgba(4, 21, 32, 0.9)');
            gradient.addColorStop(1, 'rgba(10, 37, 53, 0.9)');
            drawingContext.fillStyle = gradient;
            circle(78, 78, 156);
            pop();

            // Position coral at bottom center of circle - 1.3x bigger
            push();
            translate(78, 124);

            // Draw simple seabed - 1.3x bigger
            noStroke();
            fill(15, 35, 40, 120);
            arc(0, 0, 104, 39, 0, PI);

            // Draw coral
            strokeCap(ROUND);
            const col = coralGrowthToColor(coralGrowth);
            const grey = color(120, 120, 130);
            const branchCol = lerpColor(grey, col, coralGrowth);

            drawCoralBranch({
                len: baseLen * (0.8 + 0.2 * coralGrowth), // Starts big (80%), grows slightly bigger
                angle: -Math.PI / 2,
                depth: 0,
                thickness: baseThickness * (1.2 - 0.4 * coralGrowth), // Starts thick, gets thinner as it recovers
                colorA: branchCol
            });

            pop();

            // Add fish - dead or alive based on coral health
            drawFish();

            // Add some tiny bubbles
            drawTinyBubbles();
        }

        function easeOutCubic(t) { 
            return 1 - pow(1 - t, 3); 
        }

        function drawCoralBranch(opts) {
            const { len, angle, depth, thickness, colorA } = opts;

            if (len < minLen || depth > maxDepth) return;

            // More branches unlock as coral grows, but height stays same
            const needed = depth === 0 ? 0.01 : 0.03 + depth * 0.08;
            if (coralGrowth < needed) {
                // Bleached/dead branches - very pale and translucent
                stroke(230, 225, 220, 80);
            } else {
                stroke(colorA);
            }
            strokeWeight(thickness);

            const n = noise(depth * 1.5, frameCount * 0.005 + depth);
            const bend = map(n, 0, 1, -sway, sway);
            const a = angle + bend + 0.1 * sin(breezeT + depth);

            const x2 = len * cos(a);
            const y2 = len * sin(a);
            line(0, 0, x2, y2);

            push();
            translate(x2, y2);

            // Coral tips - get bigger and more numerous
            if (len < minLen * 4) {
                noStroke();
                const t = 0.8 + 0.2 * noise(frameCount * 0.03, depth);
                
                if (coralGrowth < 0.1) {
                    // Dead coral tips - pale white/grey, bigger and more prominent when bleached
                    const deadTip = lerpColor(color(240, 235, 230), color(210, 205, 200), t);
                    fill(deadTip);
                    // Bigger tips when bleached - looks like dead coral polyps
                    circle(0, 0, 2 + coralGrowth * 2);
                } else {
                    // Living coral tips - bright and colorful, smaller and more refined
                    const brightTip = lerpColor(colorA, color(255, 200, 100), 0.4);
                    const tip = lerpColor(color(200, 200, 210), brightTip, t * coralGrowth);
                    fill(tip);
                    // Smaller, more refined tips as it recovers
                    circle(0, 0, 1 + coralGrowth * 2);
                }
            }

            // Branches get shorter but fatter as we go deeper
            const childLen = len * (0.65 + 0.15 * noise(depth, frameCount * 0.015));
            const childThick = max(0.8, thickness * (0.8 - 0.1 * coralGrowth)); // Start thick, get more refined as it recovers

            // More splits as coral grows - creates bushier, wider coral
            const maxSplits = depth < 2 ? 3 : (depth < 4 ? 4 : 2);
            const splits = Math.floor(2 + coralGrowth * (maxSplits - 2));
            
            for (let i = 0; i < splits; i++) {
                // Wider spread creates bushier coral that fills the circle
                const spread = splitAngle * (1 + 0.3 * coralGrowth) * (1 + 0.2 * noise(depth, i));
                const angleOffset = (i - (splits - 1) / 2) * spread;
                const aChild = a + angleOffset + 0.05 * i;
                
                drawCoralBranch({
                    len: childLen,
                    angle: aChild,
                    depth: depth + 1,
                    thickness: childThick,
                    colorA
                });
            }

            pop();
        }

        function drawTinyBubbles() {
            push();
            noFill();
            stroke(200, 230, 255, 150);
            strokeWeight(1);
            
            for (let i = 0; i < 5; i++) {
                const x = 39 + 78 * noise(i * 2, frameCount * 0.01);
                const y = 26 + 104 * noise(i * 3 + 10, frameCount * 0.008);
                const size = 2 + 3 * noise(i * 5 + 20, frameCount * 0.012);
                circle(x, y, size);
            }
            pop();
        }

        function drawFish() {
            push();
            
            if (coralGrowth < 0.5) {
                // Dead fish floating around - belly up, pale
                drawDeadFish();
            } else {
                // Living fish swimming - colorful and active
                drawAliveFish();
            }
            
            pop();
        }

        function drawDeadFish() {
            // Draw 1-2 dead fish floating belly up
            for (let i = 0; i < 2; i++) {
                push();
                
                // Slow, drifting movement - wider range, 1.3x bigger
                const fishX = 33 + 78 * noise(i * 3, frameCount * 0.003 + i);
                const fishY = 26 + 65 * noise(i * 4 + 5, frameCount * 0.002 + i);
                
                translate(fishX, fishY);
                
                // Dead fish - belly up (rotated)
                rotate(PI + 0.3 * sin(frameCount * 0.01 + i));
                
                // Pale, dead fish colors - more opaque for visibility
                fill(180, 170, 160, 240);
                noStroke();
                
                // Much bigger fish shape - belly up
                ellipse(0, 0, 16, 8);  // body (doubled size)
                
                // Bigger tail
                fill(160, 150, 140, 220);
                triangle(-8, 0, -14, -4, -14, 4);
                
                // Draw single X eye for dead fish - classic cartoon death
                stroke(80, 70, 60, 220);
                strokeWeight(2);
                // Single X eye in center
                line(3, -2, 5, 0);
                line(5, -2, 3, 0);
                
                // Add some detail - dead fins
                noStroke();
                fill(150, 140, 130, 180);
                ellipse(0, 4, 4, 2); // bottom fin
                ellipse(0, -4, 4, 2); // top fin
                
                pop();
            }
        }

        function drawAliveFish() {
            // Draw 2-4 living fish swimming around
            const numFish = Math.floor(2 + coralGrowth * 2); // 2-4 fish based on growth
            
            for (let i = 0; i < numFish; i++) {
                push();
                
                // Active swimming movement - wider range, 1.3x bigger
                const fishX = 26 + 91 * noise(i * 2, frameCount * 0.008 + i);
                const fishY = 20 + 78 * noise(i * 3 + 10, frameCount * 0.006 + i);
                
                translate(fishX, fishY);
                
                // Fish swimming direction
                const swimAngle = noise(i * 5, frameCount * 0.01 + i) * PI * 2;
                rotate(swimAngle);
                
                // Colorful living fish - more vibrant and opaque
                const fishHue = (i * 60 + frameCount * 0.5) % 360;
                fill(
                    120 + 120 * sin(radians(fishHue)),
                    170 + 100 * sin(radians(fishHue + 120)),
                    220 + 75 * sin(radians(fishHue + 240)),
                    250
                );
                noStroke();
                
                // Much bigger fish body
                ellipse(0, 0, 12, 6);  // doubled size
                
                // Bigger tail
                fill(
                    100 + 100 * sin(radians(fishHue + 60)),
                    150 + 80 * sin(radians(fishHue + 180)),
                    200 + 60 * sin(radians(fishHue + 300)),
                    240
                );
                triangle(-6, 0, -10, -3, -10, 3);
                
                // Bigger living eye - more prominent
                fill(255, 255, 255, 250);
                circle(3, -0.5, 2.5);
                fill(0, 0, 0);
                circle(3.3, -0.5, 1);
                
                // Add colorful fins for more visibility
                fill(
                    140 + 80 * sin(radians(fishHue + 180)),
                    190 + 60 * sin(radians(fishHue + 300)),
                    240 + 40 * sin(radians(fishHue + 60)),
                    200
                );
                ellipse(0, 3, 5, 2.5); // bottom fin
                ellipse(0, -3, 5, 2.5); // top fin
                
                pop();
            }
        }

        // Make coral responsive to window resize
        function windowResized() {
            // Keep canvas size fixed for the circular display
        }
    </script>

    <!-- Camera Verification Modal -->
    <div id="camera-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 20px; border-radius: 15px; text-align: center; max-width: 90%; max-height: 90%;">
            <h3 id="verification-title">üì∏ Verify Your Bike Ride!</h3>
            <p id="verification-description">Take a photo of a bicycle to complete this sustainable transport goal</p>
            
            <div id="camera-container">
                <video id="camera-video" autoplay playsinline style="width: 100%; max-width: 400px; border-radius: 10px;"></video>
                <canvas id="camera-canvas" style="display: none; width: 100%; max-width: 400px; border-radius: 10px;"></canvas>
            </div>
            
            <div style="margin-top: 15px;">
                <button id="capture-btn" style="background: #4CAF50; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; margin: 5px; cursor: pointer;">
                    üì∑ Capture Photo
                </button>
                <button id="verify-btn" style="display: none; background: #2196F3; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; margin: 5px; cursor: pointer;">
                    ‚úÖ Verify & Complete
                </button>
                <button id="retake-btn" style="display: none; background: #FF9800; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; margin: 5px; cursor: pointer;">
                    üîÑ Retake Photo
                </button>
                <button id="cancel-camera-btn" style="background: #f44336; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; margin: 5px; cursor: pointer;">
                    ‚ùå Cancel
                </button>
            </div>
            
            <div id="verification-status" style="margin-top: 15px; font-weight: bold;"></div>
        </div>
    </div>

    <script>
        // Camera verification functionality
        let currentStream = null;
        let capturedImage = null;
        let currentTaskId = null;

        // Real YOLOv8 bike detection function
        async function detectBicycle(imageData) {
            try {
                const response = await fetch('http://localhost:5000/api/verify-bicycle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: imageData
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                return {
                    detected: result.detected,
                    confidence: result.confidence,
                    object: result.object || 'bicycle',
                    details: result.details
                };
            } catch (error) {
                console.error('YOLOv8 detection error:', error);
                // Fallback to mock detection if server is unavailable
                return {
                    detected: false,
                    confidence: 0.0,
                    object: 'error',
                    error: 'Detection server unavailable. Please start the YOLOv8 server.'
                };
            }
        }

        // Open camera for verification
        async function openCameraVerification(taskId, taskTitle) {
            currentTaskId = taskId;
            document.getElementById('verification-title').textContent = `üì∏ Verify: ${taskTitle}`;
            document.getElementById('camera-modal').style.display = 'flex';
            
            try {
                currentStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment', // Use back camera on mobile
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                document.getElementById('camera-video').srcObject = currentStream;
            } catch (error) {
                alert('Camera access denied. Please allow camera access to verify tasks.');
                closeCameraModal();
            }
        }

        // Capture photo
        document.getElementById('capture-btn').addEventListener('click', function() {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('camera-canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size to match display size, not video resolution
            const displayWidth = 400;
            const displayHeight = (video.videoHeight / video.videoWidth) * displayWidth;
            
            canvas.width = displayWidth;
            canvas.height = displayHeight;
            canvas.style.width = displayWidth + 'px';
            canvas.style.height = displayHeight + 'px';
            
            ctx.drawImage(video, 0, 0, displayWidth, displayHeight);
            
            capturedImage = canvas.toDataURL('image/jpeg', 0.8);
            
            // Show captured image
            video.style.display = 'none';
            canvas.style.display = 'block';
            
            // Update buttons
            document.getElementById('capture-btn').style.display = 'none';
            document.getElementById('verify-btn').style.display = 'inline-block';
            document.getElementById('retake-btn').style.display = 'inline-block';
        });

        // Retake photo
        document.getElementById('retake-btn').addEventListener('click', function() {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('camera-canvas');
            
            video.style.display = 'block';
            canvas.style.display = 'none';
            
            document.getElementById('capture-btn').style.display = 'inline-block';
            document.getElementById('verify-btn').style.display = 'none';
            document.getElementById('retake-btn').style.display = 'none';
            document.getElementById('verification-status').textContent = '';
        });

        // Verify and complete task
        document.getElementById('verify-btn').addEventListener('click', async function() {
            const statusDiv = document.getElementById('verification-status');
            statusDiv.innerHTML = 'üîç Analyzing image for bicycle...';
            statusDiv.style.color = '#2196F3';
            
            try {
                const detection = await detectBicycle(capturedImage);
                
                if (detection.error) {
                    statusDiv.innerHTML = `‚ö†Ô∏è ${detection.error}`;
                    statusDiv.style.color = '#FF9800';
                    return;
                }
                
                if (detection.detected) {
                    statusDiv.innerHTML = `‚úÖ Bicycle detected! Confidence: ${Math.round(detection.confidence * 100)}%`;
                    statusDiv.style.color = '#4CAF50';
                    
                    // Award points and update coral
                    const taskPoints = 150; // Bike task points
                    const bonusPoints = Math.floor(detection.confidence * 20); // Confidence bonus
                    const totalPoints = taskPoints + bonusPoints;
                    
                    setTimeout(() => {
                        // Update coral growth
                        setCoralPoints(coralPoints + totalPoints);
                        
                        // Show success message
                        statusDiv.innerHTML = `ü™∏ Task completed! +${totalPoints} points! Your coral reef celebrates sustainable transport!`;
                        
                        // Close modal after success
                        setTimeout(() => {
                            closeCameraModal();
                            
                            // Show coral growth animation
                            document.querySelector('.coral-testing').style.background = 'linear-gradient(135deg, #4CAF50, #8BC34A)';
                            setTimeout(() => {
                                document.querySelector('.coral-testing').style.background = '';
                            }, 2000);
                        }, 3000);
                    }, 1000);
                    
                } else {
                    statusDiv.innerHTML = '‚ùå No bicycle detected. Please take a clearer photo of a bicycle.';
                    statusDiv.style.color = '#f44336';
                    
                    // Reset for retry
                    setTimeout(() => {
                        document.getElementById('retake-btn').click();
                    }, 2000);
                }
            } catch (error) {
                statusDiv.innerHTML = '‚ö†Ô∏è Verification failed. Please try again.';
                statusDiv.style.color = '#FF9800';
            }
        });

        // Cancel camera
        document.getElementById('cancel-camera-btn').addEventListener('click', closeCameraModal);

        function closeCameraModal() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            document.getElementById('camera-modal').style.display = 'none';
            document.getElementById('camera-video').style.display = 'block';
            document.getElementById('camera-canvas').style.display = 'none';
            document.getElementById('capture-btn').style.display = 'inline-block';
            document.getElementById('verify-btn').style.display = 'none';
            document.getElementById('retake-btn').style.display = 'none';
            document.getElementById('verification-status').textContent = '';
            capturedImage = null;
            currentTaskId = null;
        }

        // Add camera verification to task completion
        function completeTaskWithVerification(taskId, taskTitle, hasVerification) {
            if (hasVerification) {
                openCameraVerification(taskId, taskTitle);
            } else {
                // Regular task completion
                setCoralPoints(coralPoints + 50); // Default points
            }
        }

        // Example: Add click handler for bike task (you'll need to integrate this with your existing task system)
        document.addEventListener('DOMContentLoaded', function() {
            // This would integrate with your existing task display system
            console.log('Camera verification system ready! üì∏üö¥‚Äç‚ôÄÔ∏è');
        });
    </script>
</body>
</html>
